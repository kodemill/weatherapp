{"version":3,"sources":["../../src/database/import-city-list.js"],"names":[],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,MAAM,eAAe,MAAM,IAAI,OAAJ,CAAY,CAAC,OAAD,EAAU,MAAV,KAAqB;AAC1D,QAAM,aAAa,aAAG,gBAAH,CAAoB,WAAG,QAAvB,CAAnB;AACA;AACA,MAAI,SAAS,eAAK,UAAL,CAAgB,yBAAhB,EAAb;AACA,QAAM,UAAU,IAAhB;AACA,MAAI,UAAU,CAAd;AACA,MAAI,aAAa,CAAjB;AACA,QAAM,KAAK,mBAAS,eAAT,CAAyB;AAClC,WAAO,UAD2B;AAElC,cAAU;AAFwB,GAAzB,CAAX;AAIA,KAAG,EAAH,CAAM,MAAN,EAAc,QAAQ;AACpB,UAAM,OAAO,KAAK,KAAL,CAAW,IAAX,CAAb;AACA;AACA,SAAK,MAAL,GAAc,KAAK,IAAL,CAAU,WAAV,EAAd;AACA;AACA;AACA;AACA;AACA,SAAK,QAAL,GAAgB;AACd,YAAM,OADQ;AAEd,mBAAa,CAAC,KAAK,KAAL,CAAW,GAAZ,EAAiB,KAAK,KAAL,CAAW,GAA5B;AAFC,KAAhB;AAIA,WAAO,KAAK,KAAZ;AACA,WAAO,MAAP,CAAc,IAAd;AACA,QAAI,EAAE,OAAF,KAAc,OAAlB,EAA2B;AACzB,aAAO,OAAP,CAAe,OAAO;AACpB,YAAI,GAAJ,EAAS;AACP,iBAAO,GAAP;AACD;AACF,OAJD;AAKA,oBAAc,OAAd;AACA,gBAAU,CAAV;AACA,eAAS,eAAK,UAAL,CAAgB,yBAAhB,EAAT;AACD;AACF,GAxBD;AAyBA,KAAG,EAAH,CAAM,OAAN,EAAe,MAAM;AACnB,kBAAc,OAAd;AACA,QAAI,YAAY,CAAhB,EAAmB;AACjB,aAAO,OAAP,CAAe,OAAO;AACpB,YAAI,GAAJ,EAAS;AACP,iBAAO,GAAP;AACD,SAFD,MAEO;AACL,kBAAQ,UAAR;AACD;AACF,OAND;AAOD,KARD,MAQO;AACL,cAAQ,UAAR;AACD;AACF,GAbD;AAcD,CAlD0B,CAA3B;;oCAoDe,aAAY;AACzB,MAAI,OAAM,eAAK,UAAL,CAAgB,KAAhB,EAAN,MAAkC,CAAtC,EAAyC;AACvC,YAAQ,GAAR,CAAY,wBAAZ;AACA,UAAM,QAAQ,KAAK,GAAL,EAAd;AACA,UAAM,gBAAgB,MAAM,cAA5B;AACA,YAAQ,GAAR,CAAa,aAAW,aAAc,gBAAa,CAAC,KAAK,GAAL,KAAa,KAAd,IAAuB,IAAK,IAA/E;AACD;AACF,C","file":"import-city-list.js","sourcesContent":["import City from '../model/city';\r\nimport fs from 'fs';\r\nimport readline from 'readline';\r\nimport { db } from '../../config';\r\n\r\nconst importCities = () => new Promise((resolve, reject) => {\r\n  const readStream = fs.createReadStream(db.cityList);\r\n  // https://docs.mongodb.com/manual/reference/method/db.collection.initializeUnorderedBulkOp\r\n  let bulkOp = City.collection.initializeUnorderedBulkOp();\r\n  const opLimit = 1000;\r\n  let opCount = 0;\r\n  let sumOpCount = 0;\r\n  const rl = readline.createInterface({\r\n    input: readStream,\r\n    terminal: false,\r\n  });\r\n  rl.on('line', line => {\r\n    const city = JSON.parse(line);\r\n    // lowercase for faster regex search\r\n    city.nameLC = city.name.toLowerCase();\r\n    // convert location into valid GeoJSON Point:\r\n    // input: \"coord\":{\"lon\":34.283333,\"lat\":44.549999}}\r\n    // WGS84: 'Coordinate-axis order is longitude, latitude'\r\n    // output \"location\":{\"type\":\"Point\",\"coordinates\":[34.283333,44.549999]}\r\n    city.location = {\r\n      type: 'Point',\r\n      coordinates: [city.coord.lon, city.coord.lat],\r\n    };\r\n    delete city.coord;\r\n    bulkOp.insert(city);\r\n    if (++opCount === opLimit) {\r\n      bulkOp.execute(err => {\r\n        if (err) {\r\n          reject(err);\r\n        }\r\n      });\r\n      sumOpCount += opCount;\r\n      opCount = 0;\r\n      bulkOp = City.collection.initializeUnorderedBulkOp();\r\n    }\r\n  });\r\n  rl.on('close', () => {\r\n    sumOpCount += opCount;\r\n    if (opCount !== 0) {\r\n      bulkOp.execute(err => {\r\n        if (err) {\r\n          reject(err);\r\n        } else {\r\n          resolve(sumOpCount);\r\n        }\r\n      });\r\n    } else {\r\n      resolve(sumOpCount);\r\n    }\r\n  });\r\n});\r\n\r\nexport default async () => {\r\n  if (await City.collection.count() === 0) {\r\n    console.log('importing city list...');\r\n    const start = Date.now();\r\n    const importedCount = await importCities();\r\n    console.log(`imported ${importedCount} cities in ${(Date.now() - start) / 1000}s`);\r\n  }\r\n};\r\n"]}