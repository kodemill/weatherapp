{"version":3,"sources":["../../src/lib/send-email.js"],"names":[],"mappings":";;;;;;;;;AAAA;;;;AACA;;AACA;;;;;;AAEA,MAAM,wBAAwB,CAAC,EAAD,EAAK,KAAL,KAAe,uBAAI,IAAJ,CAAS,EAAE,EAAF,EAAM,KAAN,EAAT,EAAwB,aAAK,SAA7B,CAA7C;;AAEA,MAAM,oBAAoB,QACzB;;;;;;OAAA,CAMM,IAAK;;QAPZ;;AAWA,MAAM,SAAU,IAAE,YAAI,GAAI,OAA1B;AACA,MAAM,4BAA4B,CAAC,KAAD,EAAQ,QAAR,EAAkB,MAAlB;AAClC;AACC,UAAQ,SAAS,IAAT,CAAc,IAAK;;qBAAA,CAEP,SAAS,SAAU,WAAQ,SAAS,WAAY,UAAO,SAAS,IAAT,CAAc,IAAK,OAAI,SAAS,IAAT,CAAc,OAAQ;wBAAA,CACjG,OAAO,WAAY;gCAAA,CACX,MAAO,4BAAyB,SAAS,EAAG,UAAO,SAAS,IAAT,CAAc,KAAM;;oDAAA,CAEnD,MAAO,iCAA8B,KAAM,0BAR/F;AASA;;AAEA,MAAM,4BAA4B;AAClC;AACC;;wDAAA,CAEuD,MAAO,4BAAyB,KAAM;;;;;;;oBAJ9F;AAYA;;AAEA,IAAI,WAAJ;AACA,MAAM,oBAAoB,MAAM;AAC9B,gBAAc,qBAAW,eAAX,CAA4B,YAAU,cAAY,OAAQ,MAAG,cAAY,QAAS,kBAAlF,CAAd;AACD,CAFD;;AAIA,MAAM,qBAAqB;AACzB,QAAM,oBADmB;AAEzB,WAAS;AAFgB,CAA3B;;AAKA,MAAM,WAAW,eAAe,IAAI,OAAJ,CAAY,CAAC,OAAD,EAAU,MAAV,KAAqB;AAC/D,MAAI,CAAC,WAAL,EAAkB;AAChB;AACD;AACD,QAAM,uBACD,kBADC,EAED,WAFC,CAAN;AAIA,cAAY,QAAZ,CAAqB,OAArB,EAA8B,CAAC,KAAD,EAAQ,IAAR,KAAiB;AAC7C,QAAI,KAAJ,EAAW;AACT,aAAO,KAAP;AACD,KAFD,MAEO;AACL,cAAQ,IAAR;AACD;AACF,GAND;AAOD,CAf+B,CAAhC;;AAiBA,MAAM,wBAAwB,CAAC,IAAD,EAAO,KAAP,KAAiB,SAAS;AACtD,WAAS,+BAD6C;AAEtD,QAAM,0BAA0B,sBAAsB,KAAK,EAA3B,EAA+B,MAAM,OAArC,CAA1B,CAFgD;AAGtD,MAAI,MAAM;AAH4C,CAAT,CAA/C;;AAMA,MAAM,wBAAwB,CAAC,QAAD,EAAW,MAAX,KAAsB;AAClD,QAAM,SAAS,SAAS,IAAT,CAAc,qBAAd,GAAsC,GAAtC,CAA0C,SAAS,MAAM,OAAzD,CAAf;AACA,QAAM,SAAS,OAAO,GAAP,CAAW,SAAS,sBAAsB,SAAS,IAAT,CAAc,EAApC,EAAwC,KAAxC,CAApB,CAAf;AACA,SAAO,QAAQ,GAAR,CAAY,OAAO,GAAP,CAAW,CAAC,KAAD,EAAQ,GAAR,KAAgB,SAAS;AACrD,UAAM,kBAAkB,0BAA0B,OAAO,GAAP,CAA1B,EAAuC,QAAvC,EAAiD,MAAjD,CAAlB,CAD+C;AAErD,QAAI;AAFiD,GAAT,CAA3B,CAAZ,CAAP;AAID,CAPD;;QASS,qB,GAAA,qB;QAAuB,qB,GAAA,qB;kBACjB,Q","file":"send-email.js","sourcesContent":["import nodemailer from 'nodemailer';\r\nimport { email as emailConfig, app, auth } from '../../config';\r\nimport jwt from 'jsonwebtoken';\r\n\r\nconst generateTokenForEmail = (id, email) => jwt.sign({ id, email }, auth.jwtSecret);\r\n\r\nconst htmlEmailTemplate = body =>\r\n`<!DOCTYPE html>\r\n<html lang=\"en-US\">\r\n <head>\r\n     <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\r\n </head>\r\n <body>\r\n     ${body}\r\n </body>\r\n</html>`;\r\n\r\nconst apiUrl = `${app.url}/api`;\r\nconst notificationEmailTemplate = (token, criteria, report) =>\r\n/* eslint-disable */\r\n`Hello ${criteria.user.name},\r\n<br><br>\r\nThe temperature is ${criteria.predicate} than ${criteria.temperature}℃ in ${criteria.city.name} (${criteria.city.country}),\r\nour latest report was ${report.temperature}℃ for that location.<br>\r\nTo acknoweledge that <a href=\"${apiUrl}/criteria/acknoweledge/${criteria.id}?jwt=${criteria.user.token}\">click here</a>.\r\n<br><br>\r\nIf you don't want to receive more emails <a href=\"${apiUrl}/auth/email/unsubscribe?jwt=${token}\">unsubscribe here</a>.`;\r\n/* eslint-enable */\r\n\r\nconst verificationEmailTemplate = token =>\r\n/* eslint-disable */\r\n`Hello there,\r\n<br>\r\nIf you know why you have received this email <a href=\"${apiUrl}/auth/email/verify?jwt=${token}\">click here</a>\r\n to confirm that the address is yours.\r\n<br>\r\nOtherwise, just ignore it.\r\n<br>\r\n<br>\r\nSincerely,\r\na concerned spammer`;\r\n/* eslint-enable */\r\n\r\nlet transporter;\r\nconst createTransporter = () => {\r\n  transporter = nodemailer.createTransport(`smtps://${emailConfig.account}:${emailConfig.password}@smtp.gmail.com`);\r\n};\r\n\r\nconst defaultMailOptions = {\r\n  from: 'WeatherApp noreply',\r\n  subject: 'WeatherApp notification',\r\n};\r\n\r\nconst sendMail = mailOptions => new Promise((resolve, reject) => {\r\n  if (!transporter) {\r\n    createTransporter();\r\n  }\r\n  const options = {\r\n    ...defaultMailOptions,\r\n    ...mailOptions,\r\n  };\r\n  transporter.sendMail(options, (error, info) => {\r\n    if (error) {\r\n      reject(error);\r\n    } else {\r\n      resolve(info);\r\n    }\r\n  });\r\n});\r\n\r\nconst sendVerificationEmail = (user, email) => sendMail({\r\n  subject: 'WeatherApp email verification',\r\n  html: verificationEmailTemplate(generateTokenForEmail(user.id, email.address)),\r\n  to: email.address,\r\n});\r\n\r\nconst sendNotificationEmail = (criteria, report) => {\r\n  const emails = criteria.user.getNotificationEmails().map(email => email.address);\r\n  const tokens = emails.map(email => generateTokenForEmail(criteria.user.id, email));\r\n  return Promise.all(emails.map((email, idx) => sendMail({\r\n    html: htmlEmailTemplate(notificationEmailTemplate(tokens[idx], criteria, report)),\r\n    to: email,\r\n  })));\r\n};\r\n\r\nexport { sendVerificationEmail, sendNotificationEmail };\r\nexport default sendMail;\r\n"]}