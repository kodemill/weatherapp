{"version":3,"sources":["../../src/lib/passport.js"],"names":[],"mappings":"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","file":"passport.js","sourcesContent":["import fetch from 'node-fetch';\r\nimport passport from 'koa-passport';\r\nimport { auth } from '../../config';\r\nimport { Strategy as GithubStrategy } from 'passport-github';\r\nimport { Strategy as FacebookStrategy } from 'passport-facebook';\r\nimport { Strategy as JwtStrategy, ExtractJwt } from 'passport-jwt';\r\nimport User from '../model/user';\r\nimport { mergeAccounts } from '../controller/user';\r\n\r\nconst fetchEmailFromGithub = async accessToken => {\r\n  try {\r\n    const response = await fetch('https://api.github.com/user/emails', {\r\n      headers: {\r\n        Authorization: `token ${accessToken}`,\r\n      },\r\n    });\r\n    if (response.ok) {\r\n      // [ { email: '', primary: true, verified: true } ]\r\n      return (await response.json())\r\n        .filter(githubEmail => githubEmail.verified)\r\n        .map(githubEmail => githubEmail.email);\r\n    }\r\n  } catch (err) {\r\n    console.log(`getEmail@github err: ${err.toString()} `);\r\n  }\r\n};\r\n\r\nconst verifyCallback = async (social, req, accessToken, _, profile, done) => {\r\n  try {\r\n    const socialIdKey = `${social}Id`;\r\n    const userId = req.query.state;\r\n    if (userId) {\r\n      // previous account\r\n      const user = await User.findById(userId);\r\n      let emails;\r\n      if (social === 'github') {\r\n        emails = await fetchEmailFromGithub(accessToken);\r\n      } else if (profile.emails && profile.emails.length > 0) {\r\n        emails = profile.emails.map(passportEmail => passportEmail.value);\r\n      }\r\n      // save email\r\n      if (emails) {\r\n        emails.forEach(email => user.addEmail({\r\n          address: email,\r\n          trusted: true,\r\n        }));\r\n      }\r\n      // save username\r\n      user.name = profile.displayName;\r\n      // connect\r\n      user[socialIdKey] = profile.id;\r\n      // check if theres an existing account for this social\r\n      const currentUser = await User.findOne({ [socialIdKey]: profile.id });\r\n      if (currentUser) {\r\n        // keep the existing drop the previous (anonymus)\r\n        mergeAccounts(currentUser, user);\r\n        return done(null, currentUser);\r\n      }\r\n      await user.save();\r\n      return done(null, user);\r\n    }\r\n    return done(null, false);\r\n  } catch (err) {\r\n    return done(err);\r\n  }\r\n};\r\n\r\nconst providerCallbackHandler = strategy => async (ctx, next) => {\r\n  await passport.authenticate(strategy, user => {\r\n    if (user) {\r\n      ctx.redirect(`/user/${user.token}`);\r\n    } else {\r\n      ctx.redirect('/');\r\n    }\r\n  })(ctx, next);\r\n};\r\n\r\nconst providerHandler = strategy => (ctx, next) =>\r\n  passport.authenticate(strategy, {\r\n    session: false,\r\n    scope: strategy === 'facebook' ? ['email'] : ['user:email'],\r\n    state: ctx.user.id, // story userId\r\n  })(ctx, next);\r\n\r\npassport.use(new GithubStrategy({\r\n  clientID: auth.githubAppId,\r\n  clientSecret: auth.githubAppSecret,\r\n  callbackURL: auth.githubLoginCallback,\r\n  passReqToCallback: true,\r\n}, verifyCallback.bind(null, 'github')));\r\n\r\npassport.use(new FacebookStrategy({\r\n  clientID: auth.facebookAppId,\r\n  clientSecret: auth.facebookAppSecret,\r\n  callbackURL: auth.facebookLoginCallback,\r\n  profileFields: ['id', 'emails', 'name'],\r\n  passReqToCallback: true,\r\n}, verifyCallback.bind(null, 'facebook')));\r\n\r\npassport.use(new JwtStrategy({\r\n  secretOrKey: auth.jwtSecret,\r\n  jwtFromRequest: ExtractJwt.fromExtractors([\r\n    ExtractJwt.fromAuthHeader(),\r\n    ExtractJwt.fromUrlQueryParameter('jwt'),\r\n  ]),\r\n}, (payload, done) => User.findById(payload.id, done)));\r\n\r\npassport.use('email-jwt', new JwtStrategy({\r\n  secretOrKey: auth.jwtSecret,\r\n  jwtFromRequest: ExtractJwt.fromExtractors([\r\n    ExtractJwt.fromUrlQueryParameter('jwt'),\r\n  ]),\r\n}, async (payload, done) => {\r\n  try {\r\n    const user = await User.findOne({\r\n      _id: payload.id,\r\n      'emails.address': payload.email,\r\n    });\r\n    if (!user) {\r\n      return done(null, false);\r\n    }\r\n    user.email = payload.email;\r\n    return done(null, user);\r\n  } catch (err) {\r\n    return done(err);\r\n  }\r\n}));\r\n\r\nexport default passport;\r\nexport { providerCallbackHandler, providerHandler };\r\n"]}