{"version":3,"sources":["../../src/controller/weather-criteria.js"],"names":[],"mappings":"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","file":"weather-criteria.js","sourcesContent":["import { WeatherCriteria, City } from '../model';\nimport constants from '../constants';\n\nconst getAllPending = () => WeatherCriteria\n  .find({ fulfilledAt: null });\n\nconst getAllFulfilledNotAcknoweledged = () =>\n  WeatherCriteria.find({\n    fulfilledAt: { $ne: null },\n    acknoweledgedAt: null,\n  });\n\nconst fulfill = criteria => {\n  criteria.fulfilledAt = Date.now();\n  return criteria.save();\n};\n\nconst tryFulfillFromReports = async (criteria, reports) =>\n  await Promise.all(\n    criteria.filter(criterion => {\n      const cityReport = reports.find(report => report.city === criterion.city);\n      return cityReport && criterion.isFulfilledWithTemperature(cityReport.temperature);\n    })\n    .map(fulfill)\n  );\n\nconst saveCriteria = async (criteria, overwriteExisting) => {\n  if (criteria.predicate !== 'less' && criteria.predicate !== 'greater') {\n    throw new Error('wrong predicate');\n  }\n  if (!criteria.user) {\n    throw new Error('user not found');\n  }\n  const city = await City.findById(criteria.cityId);\n  if (!city) {\n    throw new Error('city not found');\n  }\n  const existingCriteria = await WeatherCriteria.findOne({\n    user: criteria.user,\n    city,\n    predicate: criteria.predicate,\n    fulfilledAt: null,\n  });\n  if (existingCriteria) {\n    if (!overwriteExisting) {\n      const err = new Error('criteria already exists');\n      err.existingCriteria = existingCriteria;\n      throw err;\n    } else {\n      existingCriteria.temperature = criteria.temperature;\n      return await existingCriteria.save();\n    }\n  }\n  return await WeatherCriteria.create({\n    user: criteria.user,\n    city,\n    predicate: criteria.predicate,\n    temperature: criteria.temperature,\n  });\n};\n\nconst getAllUpdatedAfterForUser = async (user, updatedAfter) =>\n  await WeatherCriteria.find({\n    user,\n    updatedAt: { $gte: new Date(updatedAfter) },\n  }).limit(constants.listLimit)\n  .populate('city');\n\nconst getAllForUser = async user =>\n  await WeatherCriteria.find({ user }).limit(constants.listLimit).populate('city');\n\nconst getAllPendingForUser = async user =>\n  await WeatherCriteria.find({ user, fulfilledAt: null })\n    .limit(constants.listLimit)\n    .populate('city');\n\nconst getAllFulfilledForUser = async user =>\n  await WeatherCriteria.find({ user, fulfilledAt: { $ne: null } })\n  .limit(constants.listLimit)\n  .populate('city');\n\nconst getAllFulfilledNotAcknoweledgedForUser = async user =>\n  await WeatherCriteria.find({\n    user,\n    fulfilledAt: { $ne: null },\n    acknoweledgedAt: null,\n  }).limit(constants.listLimit)\n  .populate('city');\n\nconst acknoweledgeForUser = async (user, criteriaId) => {\n  const criteria = await WeatherCriteria.findOne({ user, _id: criteriaId }).populate('city');\n  if (!criteria) {\n    throw new Error('Not found');\n  }\n  if (!criteria.fulfilledAt) {\n    throw new Error('Not fulfilled yet');\n  }\n  if (criteria.acknoweledgedAt) {\n    return criteria;\n  }\n  criteria.acknoweledgedAt = new Date();\n  return await criteria.save();\n};\n\nconst acknoweledgeAllForUser = async (user, criteriaIds) =>\n  await Promise.all(criteriaIds.map(id => acknoweledgeForUser(user, id)));\n\nconst deleteForUser = async (user, criteriaId) => {\n  const criteria = await WeatherCriteria.findOne({\n    user,\n    _id: criteriaId,\n  });\n  if (!criteria) {\n    throw new Error('Not found');\n  }\n  await criteria.remove();\n};\n\nexport default {\n  getAllPending,\n  getAllFulfilledNotAcknoweledged,\n  tryFulfillFromReports,\n  saveCriteria,\n  getAllUpdatedAfterForUser,\n  getAllForUser,\n  getAllFulfilledForUser,\n  getAllPendingForUser,\n  getAllFulfilledNotAcknoweledgedForUser,\n  acknoweledgeForUser,\n  acknoweledgeAllForUser,\n  deleteForUser,\n};\n"]}