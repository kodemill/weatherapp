{"version":3,"sources":["../../src/controller/user.js"],"names":[],"mappings":";;;;;;;AAAA;;AACA;;;;AACA;;;;;;AAEA,MAAM;AAAA,+BAAgB,WAAO,IAAP,EAAa,IAAb,EAAsB;AAC1C;AACA,UAAM,WAAW,MAAM,uBAAgB,IAAhB,CAAqB,EAAE,MAAM,IAAR,EAArB,CAAvB;AACA,UAAM,QAAQ,GAAR,CAAY,SAAS,GAAT,CAAa,qBAAa;AAC1C,gBAAU,IAAV,GAAiB,IAAjB;AACA,aAAO,UAAU,IAAV,EAAP;AACD,KAHiB,CAAZ,CAAN;AAIA;AACA,QAAI,KAAK,MAAT,EAAiB;AACf,WAAK,MAAL,CAAY,OAAZ,CAAoB;AAAA,eAAS,KAAK,QAAL,CAAc,KAAd,CAAT;AAAA,OAApB;AACD;AACD;AACA,QAAI,KAAK,OAAL,IAAgB,KAAK,OAAzB,EAAkC;AAChC,WAAK,YAAL,CAAkB,KAAK,OAAvB;AACD;AACD,WAAO,MAAM,KAAK,MAAL,EAAb;AACD,GAhBK;;AAAA;AAAA;AAAA;AAAA,IAAN;;AAkBA;AACA,MAAM;AAAA,gCAAkB,WAAO,IAAP,EAAa,OAAb,EAAyB;AAC/C;AACA,QAAI,QAAQ,MAAZ,EAAoB;AAClB,YAAM,WAAW,iBAAE,YAAF,CAAe,KAAK,MAApB,EAA4B,QAAQ,MAApC,EAA4C,SAA5C,CAAjB;AACA,YAAM,QAAQ,iBAAE,YAAF,CAAe,QAAQ,MAAvB,EAA+B,KAAK,MAApC,EAA4C,SAA5C,CAAd;AACA,YAAM,qBAAqB,iBAAE,YAAF,CAAe,QAAQ,MAAvB,EAA+B,KAA/B,EAAsC,SAAtC,CAA3B;AACA;AACA,eAAS,OAAT,CAAiB;AAAA,eAAS,MAAM,MAAN,EAAT;AAAA,OAAjB;AACA;AACA,YAAM,OAAN,CAAc;AAAA,eAAS,KAAK,QAAL,CAAc,KAAd,CAAT;AAAA,OAAd;AACA,YAAM,QAAQ,GAAR,CAAY,MAAM,GAAN,CAAU;AAAA,eAAS,sCAAsB,IAAtB,EAA4B,KAA5B,CAAT;AAAA,OAAV,CAAZ,CAAN;AACA;AACA,yBAAmB,OAAnB,CAA2B,iBAAS;AAClC,aAAK,SAAL,CAAe,KAAf,EAAsB,gBAAtB,GAAyC,MAAM,gBAA/C;AACD,OAFD;AAGD;AACD,QAAI,QAAQ,IAAZ,EAAkB;AAChB,WAAK,IAAL,GAAY,QAAQ,IAApB;AACD;AACD,QAAI,QAAQ,OAAZ,EAAqB;AACnB,WAAK,OAAL,GAAe,QAAQ,OAAvB;AACD;AACD,WAAO,MAAM,KAAK,IAAL,EAAb;AACD,GAvBK;;AAAA;AAAA;AAAA;AAAA,IAAN;;AAyBA,MAAM;AAAA,gCAA4B,WAAO,IAAP,EAAa,OAAb,EAAyB;AACzD,UAAM,aAAa,KAAK,MAAL,CAAY,IAAZ,CAAiB;AAAA,aAAS,MAAM,OAAN,KAAkB,OAA3B;AAAA,KAAjB,CAAnB;AACA,QAAI,UAAJ,EAAgB;AACd,iBAAW,OAAX,GAAqB,IAArB;AACA,YAAM,KAAK,IAAL,EAAN;AACD;AACF,GANK;;AAAA;AAAA;AAAA;AAAA,IAAN;;AAQA,MAAM;AAAA,gCAAiC,WAAO,IAAP,EAAa,OAAb,EAAyB;AAC9D,UAAM,aAAa,KAAK,MAAL,CAAY,IAAZ,CAAiB;AAAA,aAAS,MAAM,OAAN,KAAkB,OAA3B;AAAA,KAAjB,CAAnB;AACA,QAAI,UAAJ,EAAgB;AACd,iBAAW,gBAAX,GAA8B,KAA9B;AACA,YAAM,KAAK,IAAL,EAAN;AACD;AACF,GANK;;AAAA;AAAA;AAAA;AAAA,IAAN;;QAQS,a,GAAA,a;QAAe,e,GAAA,e;QACtB,yB,GAAA,yB;QAA2B,8B,GAAA,8B","file":"user.js","sourcesContent":["import { WeatherCriteria } from '../model';\r\nimport _ from 'lodash';\r\nimport { sendVerificationEmail } from '../lib/send-email';\r\n\r\nconst mergeAccounts = async (into, from) => {\r\n  // merge criteria\r\n  const criteria = await WeatherCriteria.find({ user: from });\r\n  await Promise.all(criteria.map(criterion => {\r\n    criterion.user = into;\r\n    return criterion.save();\r\n  }));\r\n  // merge emails\r\n  if (from.emails) {\r\n    from.emails.forEach(email => into.addEmail(email));\r\n  }\r\n  // merge options\r\n  if (into.options && from.options) {\r\n    into.mergeOptions(from.options);\r\n  }\r\n  return await from.remove();\r\n};\r\n\r\n// trust everything except 'trustedness' of emails\r\nconst saveUserForUser = async (user, changes) => {\r\n  // emails, options, name\r\n  if (changes.emails) {\r\n    const toRemove = _.differenceBy(user.emails, changes.emails, 'address');\r\n    const toAdd = _.differenceBy(changes.emails, user.emails, 'address');\r\n    const notificationChange = _.differenceBy(changes.emails, toAdd, 'address');\r\n    // remove\r\n    toRemove.forEach(email => email.remove());\r\n    // add new\r\n    toAdd.forEach(email => user.addEmail(email));\r\n    await Promise.all(toAdd.map(email => sendVerificationEmail(user, email)));\r\n    // notification changes\r\n    notificationChange.forEach(email => {\r\n      user.findEmail(email).sendNotification = email.sendNotification;\r\n    });\r\n  }\r\n  if (changes.name) {\r\n    user.name = changes.name;\r\n  }\r\n  if (changes.options) {\r\n    user.options = changes.options;\r\n  }\r\n  return await user.save();\r\n};\r\n\r\nconst verifyEmailForUserViaMail = async (user, address) => {\r\n  const foundEmail = user.emails.find(email => email.address === address);\r\n  if (foundEmail) {\r\n    foundEmail.trusted = true;\r\n    await user.save();\r\n  }\r\n};\r\n\r\nconst unsubscribeEmailForUserViaMail = async (user, address) => {\r\n  const foundEmail = user.emails.find(email => email.address === address);\r\n  if (foundEmail) {\r\n    foundEmail.sendNotification = false;\r\n    await user.save();\r\n  }\r\n};\r\n\r\nexport { mergeAccounts, saveUserForUser,\r\n  verifyEmailForUserViaMail, unsubscribeEmailForUserViaMail };\r\n"]}